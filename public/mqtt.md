# MQTT Message Queue Telemerty Transport

Легкий, компактный и открытый протокол обмена данными, созданный для передачи данных, по каналам с низкой пропускной способностью и возможны потери соединения.

<img src="http://yuml.me/diagram/scruffy;dir:LR/class/[Publisher{bg:wheat}]-connect[Broker{bg:thistle}],[Publisher]->✉[Broker],[Broker]-.-connect[Subscriber],[Broker]->✉[Subscriber]">

Основные особенности протокола `MQTT`:

- Асинхронный протокол
- Компактные сообщения.
- Работа в условиях нестабильной связи на линии передачи данных.
- `QoS` поддержка нескольких уровней качества обслуживания.
- Легкая интеграция новых устройств.

Протокол `MQTT` работает на прикладном уровне поверх TCP/IP и использует по умолчанию `1883` порт (`8883` при подключении через `SSL`).

Обмен сообщениями в протоколе `MQTT` осуществляется между клиентом (client), который может быть издателем или подписчиком (publisher/subscriber) сообщений, и брокером (broker) сообщений.

Издатель отправляет данные на `MQTT` брокер, указывая в сообщении определенную тему, топик (topic). Подписчики могут получать разные данные от множества издателей в зависимости от подписки на соответствующие топики.

## Семантика топиков

Топики представляют собой символы с кодировкой `UTF-8`. Иерархическая структура топиков имеет формат «дерева», что упрощает их организацию и доступ к данным. Топики состоят из одного или нескольких уровней, которые разделены между собой символом `/`.

Пример топика в который датчик температуры, расположенный в спальной комнате публикует данные брокеру:

`/home/living-space/living-room1/temperature`

Подписчик может так же получать данные сразу с нескольких топиков, для этого существуют `wildcard`. Они бывают двух типов: одноуровневые и многоуровневые. Для более простого понимания рассмотрим в примерах каждый из них:

### Одноуровневый `wildcard`.

Для его использования применяется символ `+`.

К примеру, нам необходимо получить данные о температуры во всех спальных комнатах:

`/home/living-space/+/temperature`

В результате получаем данные с топиков:

```
/home/living-space/living-room1/temperature
/home/living-space/living-room2/temperature
/home/living-space/living-room3/temperature
```

### Многоуровневый `wildcard`.

Для его использования применяется символ `#`.

К примеру, чтобы получить данные с различных датчиков всех спален в доме:

`/home/living-space/#`

В результате получаем данные с топиков:

```
/home/living-space/living-room1/temperature
/home/living-space/living-room1/light1
/home/living-space/living-room1/light2
/home/living-space/living-room1/humidity
/home/living-space/living-room2/temperature
/home/living-space/living-room2/light1
```

## Структура сообщений

`MQTT` сообщение состоит из нескольких частей:

- Фиксированный заголовок (присутствует по всех сообщениях).
- Переменный заголовок (присутствует только в определенных сообщениях).
- Данные, «нагрузка» (присутствует только в определенных сообщениях).

Всего в протоколе `MQTT` существует 15 типов сообщений:

Тип сообщения |	Значение	| Направление передачи	| Описание |
--------------|-----------|-----------------------|----------|
Reserved	| 0000 (0) |	нет	| Зарезервирован
CONNECT |	0001 (1) | К -> С |	Запрос клиента на подключение к серверу
CONNACK	| 0010 (2) | К <- С	| Подтверждение успешного подключения
PUBLISH	| 0011 (3) | К <- С, К -> С	| Публикация сообщения
PUBACK	| 0100 (4) | К <- С, К -> С	| Подтверждение публикации
PUBREC	| 0101 (5) | К <- С, К -> С	| Публикация получена
PUBREL	| 0110 (6) | К <- С, К -> С	| Разрешение на удаление сообщения
PUBCOMP	| 0111 (7) | К <- С, К -> С	| Публикация завершена
SUBSCRIBE	| 1000 (8) | К -> С	| Запрос на подписку
SUBACK	| 1001 (9) | К <- С	| Запрос на подписку принят
UNSUBSCRIBE	| 1010 (10) | К -> С | Запрос на отписку
UNSUBACK	| 1011 (11) | К <- С | Запрос на отписку принят
PINGREQ	| 1100 (12) | К -> С | PING запрос
PINGRESP	| 1101 (13) | К <- С | PING ответ
DISCONNECT	| 1110 (14) | К -> С | Сообщение об отключении от сервера
Reserved	| 1111 (15) | | Зарезервирован

## Флаги

Четыре старших бита первого байта фиксированного заголовка отведены под специальные флаги:

- `DUP` – флаг дубликата устанавливается, когда клиент или `MQTT` брокер совершает повторную отправку пакета (используется в типах `PUBLISH`, `SUBSCRIBE`, `UNSUBSCRIBE`, `PUBREL`). При установленном флаге переменный заголовок должен содержать Message ID (идентификатор сообщения)

- `QoS` – качество обслуживания (0, 1, 2)

- `RETAIN` – при публикации данных с установленным флагом `retain`, брокер сохранит его. При следующей подписке на этот топик брокер незамедлительно отправит сообщение с этим флагом. Используется только в сообщениях с типом `PUBLISH`.

<table class="tg">
  <tr>
    <th>Bit</th>
    <th>7</th>
    <th>6</th>
    <th>5</th>
    <th>4</th>
    <th>3</th>
    <th>2</th>
    <th>1</th>
    <th>0</th>
  </tr>
  <tr>
    <td>Byte 1</td>
    <td colspan="4">Message Type</td>
    <td>DUP</td>
    <td colspan="2">QoS</td>
    <td>Retain</td>
  </tr>
  <tr>
    <td>Byte 2</td>
    <td colspan="8">Remaining Length</td>
  </tr>
  <tr>
    <td>Byte 8</td>
    <td>User name</td>
    <td>Password</td>
    <td>Will Retain</td>
    <td colspan="2">Will QoS</td>
    <td>Will Flag</td>
    <td>Clean session</td>
    <td>Reserved</td>
  </tr>
</table>

## Качество обслуживания в протоколе MQTT (QoS)

MQTT поддерживает три уровня качества обслуживания (QoS) при передаче сообщений.

- `QoS 0` *At most once*. На этом уровне издатель один раз отправляет сообщение брокеру и не ждет подтверждения от него, то есть отправил и забыл.

<img src="http://yuml.me/diagram/scruffy;dir:LR/class/[Publisher{bg:wheat}]PUBLISH-.->[Broker{bg:thistle}]">

- `QoS 1` *At least once*. Этот уровень гарантирует, что сообщение точно будет доставлено брокеру, но есть вероятность дублирования сообщений от издателя. После получения дубликата сообщения, брокер снова рассылает это сообщение подписчикам, а издателю снова отправляет подтверждение о получении сообщения. Если издатель не получил `PUBACK` сообщения от брокера, он повторно отправляет этот пакет, при этом в DUP устанавливается `1`.

<img src="http://yuml.me/diagram/scruffy;dir:LR/class/[Publisher{bg:wheat}]PUBLISH->[Broker{bg:thistle}],[Broker]PUBACK-.->[Publisher]">

- `QoS 2` `Exactly once`. На этом уровне гарантируется доставка сообщений подписчику и исключается возможное дублирование отправленных сообщений.

<img src="http://yuml.me/diagram/scruffy;dir:LR/class/[Publisher{bg:wheat}]PUBLISH->[Broker{bg:thistle}],[Broker]PUBREC->[Publisher],[Publisher{bg:wheat}]PUBREL->[Broker{bg:thistle}],[Broker]PUBCOMP->[Publisher]">


Издатель отправляет сообщение брокеру. В этом сообщении указывается уникальный `Packet ID`, `QoS=2` и `DUP=0`. Издатель хранит сообщение неподтвержденным пока не получит от брокера ответ `PUBREC`. Брокер отвечает сообщением `PUBREC` в котором содержится тот же `Packet ID`. После его получения издатель отправляет `PUBREL` с тем же `Packet ID`. До того, как брокер получит `PUBREL` он должен хранить копию сообщения у себя. После получения `PUBREL` он удаляет копию сообщения и отправляет издателю сообщение `PUBCOMP` о том, что транзакция завершена.

## Защита передачи данных

Для обеспечения безопасности в `MQTT` протоколе реализованы следующие методы защиты:

- Аутентификация клиентов. Пакет `CONNECT` может содержать в себе поля `USERNAME` и `PASSWORD`. При реализации брокера можно использовать эти поля для аутентификации клиента.

- Контроль доступа клиентов через `Client ID`.

- Подключение к брокеру через `TLS/SSL`.
