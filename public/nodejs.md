## Node.js

### Event Loop

Цикл событий (Event Loop) - это то, что позволяет Node.js выполнять неблокирующие операции ввода/вывода.

Цикл событий выполняется до тех пор, пока есть:
- ожидающие таймеры.
- ожидающие задачи `OS`, пр. прослушивается порт.
- отложенные вызовы, пр. `stream`, `fs`.

Порядок выполнения операций в цикле событий:

- `Node.js` смотрит на ожидающие таймеры `setTimeout`, `setInterval` и понимает, готовы ли какие-либо функции к вызову.

- `Node.js` смотрит на ожидающие задачи `OS` (кроме событий `close`) и отложенные вызовы, в случае готовности вызывает `callback`.

- Приостановка выполнения. Используется только для внутренних целей. Продолжится, когда:
  - Выполнится ожидающие задачи от `OS`, пр. `TCP` соединение.
  - Выполнится отложенный вызов, пр. операции модуля `fs`.
  - Истечет `4 ms`.

- `Node.js` смотрит на ожидающии таймеры, вызвает функицю переданную `setImmediate`.

- Обработка событий `close`.

##### Microtasks

Это `Promise.then()` и `process.nextTick()`. Микротаски выполняются после выполнения всех текущих операций в стеке. Такая возможность позволяет вызвать на переменной, содержащей промис снова метод `.then()`.

`stack` - это структура даных, которая работает по принципу `LIFO` (last in, first out) последним пришёл - первым обслужен.

`scope` - это структура даных, которая работает по принципу `FIFO` (first in, first out) первым пришёл - первым обслужен.

#### Схема памяти V8

Выделяемая память называется `Resident Set`. `V8` использует схему, похожую на схему Java Virtual Machine, и делит память на сегменты:

`Code` выполняемый в данный момент код.
`Stack` содержит все примитивные типы значений.
`Heap` предназначен для хранения ссылочных типов вроде объектов.

Принцип сборки мусора довольно прост: если на сегмент памяти никто не ссылается, можно считать, что он не используется, и очистить его.
Для анализа дампов `Heap` Chrome предоставляет `V8-profiler`, который можно использовать в Chrome Developer Tools.
Chrome Developer Tools позволяет сравнивать различные файлы. Сопоставляя 2 дампа, мы получаем дельту значений, которая показывает, какие структуры возрастают между двумя дампами.

Чтобы заставить сборщик мусора очисть объект, нужно просто присвоить к нему `null`.
